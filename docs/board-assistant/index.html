<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Board Assistant ¬∑ Toolkit</title>
  <link rel="stylesheet" href="../assets/toolkit.css" />
  <style>
    /* Minimal local styles for the drag button & layout */
    .hero { margin: 12px 0 16px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .drag-btn{
      display:inline-flex; align-items:center; gap:10px; user-select:none; cursor:grab;
      background: linear-gradient(180deg, #22d3ee, #38bdf8);
      color:#06101b; font-weight:900; letter-spacing:.25px; text-decoration:none;
      border:1px solid #0ea5e9; border-radius:12px; padding:10px 14px;
      box-shadow:0 14px 30px rgba(14,165,233,.35);
    }
    .drag-btn:active{ cursor:grabbing; transform: translateY(1px); }
    .caret{ width:0; height:0; border-left:6px solid transparent; border-right:6px solid transparent; border-top:7px solid currentColor; }
    .note{ font-size:12px; color:var(--muted); }
    .ok{ color:#78f3a2; font-size:12px; }
    .err{ color:#ff7b7b; font-size:12px; }
    .lead{ opacity:.9 }
    /* keep the page focused on BA only (no extra nav) */
  </style>
</head>
<body>
  <header class="app">
    <div class="header-inner">
      <h1 class="h1"><span class="logo">üìã</span> Board Assistant</h1>
      <div class="sub">Drag this button to your bookmarks bar and run it on the Arrive Tracking Board.</div>
    </div>
  </header>

  <main class="container">
    <section class="card hero">
      <h2 class="h2">What it does</h2>
      <p class="lead">
        A compact assistant for the Arrive <strong>Tracking Board</strong>. It lets you copy per-carrier lines in several formats
        (lane, truck#, PU/DEL appointments, city) and shows a sleek sidecar next to the load modal with a clean ‚ÄúCopy as‚Ä¶‚Äù dropdown.
        You can optionally append <em>- HIGH RISK</em> to any format.
      </p>
      <div class="row" style="margin-top:8px">
        <a id="drag" class="drag-btn" href="#">
          Bassist
          <span class="caret"></span>
        </a>
        <span id="status" class="note"></span>
      </div>
      <p class="note" style="margin-top:6px">Drag this button to your bookmarks bar.</p>
    </section>

    <section class="card">
      <h3>How it works</h3>
      <ul>
        <li><strong>Where it runs</strong>: Only on the Arrive <em>Tracking Board</em> (the loads table page).</li>
        <li><strong>Scope</strong>: It indexes and displays <em>only the loads visible on the current page</em>.
          If you change page, filters, or sorting, use <em>Refresh Loads</em> to re-index.</li>
        <li><strong>Panel</strong>: A dock button appears near ‚ÄúSave Search‚Äù. The panel includes
          <em>Refresh Loads</em>, <em>Clear Checks</em>, and <em>Close</em>, and copy options:
          <ul>
            <li>Formats: lane only; lane + truck#; lane + truck# + APPT; APPT only; ‚ÄúPick Up / Delivery city‚Äù; email style.</li>
            <li>Appointment source selector (PU / DEL) and ‚ÄúCity used in format‚Äù (Pick Up / Delivery).</li>
            <li>Option to include <code>- HIGH RISK</code> at the end of the line.</li>
            <li>Format changes apply instantly when copying (no need to refresh loads just to switch formats).</li>
          </ul>
        </li>
        <li><strong>Copying</strong>: Click a carrier in the list to copy all its lines based on your current settings.</li>
        <li><strong>Sidecar</strong>: When a load modal is open, a sidecard appears at its left with a <em>Copy</em> button
          and a dropdown to ‚ÄúCopy as‚Ä¶‚Äù alternate formats (with PU/DEL variants). The dropdown opens right under the Copy button.</li>
        <li><strong>Resilience</strong>: If the modal is open but the load row isn‚Äôt on the current page yet, the sidecar can
          read data from the modal as a fallback. Hitting <em>Refresh Loads</em> re-hydrates the sidecar so it stays in sync.</li>
        <li><strong>UX</strong>: The panel closes when you click outside. Your preferences (format, PU/DEL, city, HIGH RISK)
          are saved locally and reused next time.</li>
      </ul>
      <p class="note" style="margin-top:8px">
        The bookmarklet injects a module script into the page with a cache-buster to always load the latest version.
      </p>
    </section>
  </main>

  <script>
    function makeLoaderHref(key, absUrl) {
      const code =
        "var d=document,id='bm-"+key+"',old=d.getElementById(id);" +
        "if(old) old.remove();" +
        "var s=d.createElement('script');" +
        "s.src='"+absUrl+(absUrl.includes('?')?'&':'?')+"v='+Date.now();" +
        "s.id=id;" +
        "s.type='module';" +
        "(d.body||d.documentElement).appendChild(s);";
      return "javascript:(function(){"+code+"})();";
    }
    async function isScriptNonEmpty(path) {
      const url = path + (path.includes('?') ? '&' : '?') + 'v=' + Date.now();
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const txt = await res.text();
      return txt.trim().length > 0;
    }

    const DEFAULT_PATH = '../bookmarklets/scripts/full-board-assistant.js';
    const $drag = document.getElementById('drag');
    const $status = document.getElementById('status');

    function setDisabled(msg){
      $drag.setAttribute('href', 'javascript:void(0)');
      $drag.style.opacity = '0.6';
      $drag.style.cursor = 'not-allowed';
      $status.textContent = '‚ö† ' + (msg || 'Unavailable');
      $status.className = 'err';
    }
    function setEnabled(href){
      $drag.setAttribute('href', href);
      $drag.style.opacity = '';
      $drag.style.cursor = 'grab';
      $status.textContent = '‚úì ready ‚Äî drag the button';
      $status.className = 'ok';
    }

    (async () => {
      try {
        const abs = new URL(DEFAULT_PATH, location.href).href;
        const ok = await isScriptNonEmpty(DEFAULT_PATH);
        if (!ok) { setDisabled('Empty file'); return; }
        const href = makeLoaderHref('board-assistant', abs);
        setEnabled(href);
      } catch (e) {
        setDisabled('Error loading file');
      }
    })();
  </script>
</body>
</html>

